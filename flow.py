import requests
import json
import time

port = 5000
host_api = "http://127.0.0.1:" + str(port)
# print(host)

#This parameters has to be specified before running the script
target_name = "Target from python script final 22"
hosts = ["127.0.0.1"]

task_name = target_name + " report"
target_id = None
task_id = None
# api_endpoint=host+"/getAllTargets"
# response=requests.get(api_endpoint)
# print(response.text)

api_endpoint = host_api + "/createTarget"
print(api_endpoint)
data = {"name": target_name, "hosts": hosts}
response = requests.post(url=api_endpoint, headers={"content-type": "application/json"}, data=json.dumps(data))
if response.status_code == 200:
    print("Target created successfully ", response.text)
    target_id = response.text
else:
    print(response.text)
    exit()
# #
api_endpoint = host_api + "/createTask"
print(api_endpoint)
data = {"name": task_name, "id": target_id}
print(response, target_id)
response = requests.post(url=api_endpoint, headers={"content-type": "application/json"}, data=json.dumps(data))
if response.status_code == 200:
    print("Task created successfully ", response.text)
    task_id = response.text
else:
    print(response.text)
    exit()

# #
api_endpoint = host_api + "/startTask"
print(api_endpoint)
data = {"task_id": task_id}
response = requests.post(url=api_endpoint, headers={"content-type": "application/json"}, data=json.dumps(data))
if response.status_code == 200:
    print(response.text)
else:
    print(response.text)
    exit()
# # # time.sleep(30)
api_endpoint = host_api + "/getTaskStatus"
# print(api_endpoint)
# task_id="9143b869-aa9e-4ec3-a955-c6e6dbba8b05"
data = {'task_id': task_id}
# print(data)
response = requests.post(url=api_endpoint, headers={"content-type": "application/json"}, data=json.dumps(data))
if response.status_code == 200:
    print(response.text)
else:
    print(response.text)
    exit()
# print(json.loads(response.text)["status"])
#
while True:
    response = requests.post(url=api_endpoint, headers={"content-type": "application/json"}, data=json.dumps(data))

    if response.status_code == 200:
        print(response.text)
    else:
        print(response.text)
        exit()
    if json.loads(response.text)["status"] == "Done":
        break
    print("Status:", json.loads(response.text)["status"], "\nProgress: ", json.loads(response.text)["progress"])
    time.sleep(60)

api_endpoint = host_api + "/getReportByTask"
response = requests.post(url=api_endpoint, headers={"content-type": "application/json"}, data=json.dumps(data))
print(response.text)
report_id = json.loads(response.text)["report"]

#This report id has to be inserted in the database.
#Later on use /getReport to download the report with a POST request.
#Usage {"id": report_id}

print(report_id)
